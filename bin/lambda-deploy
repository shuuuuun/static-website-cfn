#!/bin/sh

set -eu

# TODO: 関数を指定できるようにする
# TODO: 設定をproject.json/functions.jsonから読み込む
# TODO: bin/initとzip化など共通化

AWS_REGION="us-east-1"
AWS_PROFILE="static-website-sample"
FUNCTION_NAME="basic_auth"
HANDLER="index.handler"
TIMEOUT="1"

ROOT_PATH="$(cd "$(dirname $0)/../"; pwd)"
func_dir="$ROOT_PATH/functions/$FUNCTION_NAME"
tmp_file="tmp.zip"

cd "$func_dir" && yarn install

cd "$func_dir"
zip -r $tmp_file .

aws lambda update-function-code \
  --region $AWS_REGION \
  --profile $AWS_PROFILE \
  --function-name $FUNCTION_NAME \
  --zip-file fileb://$tmp_file

aws lambda update-function-configuration \
  --region $AWS_REGION \
  --profile $AWS_PROFILE \
  --function-name $FUNCTION_NAME \
  --handler $HANDLER \
  --timeout $TIMEOUT

rm "$tmp_file"
